#### 6.1 定时器结构 

|   **结构**   |                                                       **组成**                                                        |
|:------------:|:---------------------------------------------------------------------------------------------------------------------:|
|   时钟控制   |                                            预分频器 Prescaler；分频器 MUX                                             |
| 定时器主结构 | 初值计时器（TCNTBn）、减法计数器（TCNTn）、比较缓冲寄存器（TCMPBn+TCMPn）双缓冲、观察寄存器（TCNTOn）、控制逻辑等部分 |

![[Pasted image 20230211195820.png]]

#### 6.2 定时器工作过程 

* 手动装填初值（写 TCNTBn）$\Rightarrow$ 决定 PWM 频率
* 启动计数器（写 TCON）
* 计数结束（TCNTn=0），产生中断请求，可以自动装填初值继续计数

#### 6.3 PWM 输出原理 

* 寄存器 TCNTn（减法计数器）中的值减至与 TCMPBn（比较缓冲寄存器）相等时，TOUTn 的输出取反 
	* **TCMPBn** 的值决定 PWM 的不同**占空比**，**TCNTBn** 的值决定 PWM 的**频率**
	* 若得到**更高**的 PWM 占空比，则要**增加** TCMPBn 的值，反之减少
	* 若果使用反相器，则控制 PWM 的规律正好相反

#### 6.4 计数时钟和输出计算 

* **定时器输入时钟频率** $f_{\mathrm{Tclk}}$ ——计数时钟频率
  $f_{\mathrm{Tclk}}=分频值\times\frac{f_{\mathrm{pclk}}}{\mathrm{Prescaler}+1}$ 
	* $\mathrm{Prescaler}$ 预分频值\[0:255\]
	* 分频值：1/2, 1/4， 1/8， 1/16
* **PWM 输出时钟频率**：$\mathrm{PWM 输出时钟频率}=\frac{{f_\mathrm{Tclk}}}{\mathrm{TCNTBn}}$ 
* **PWM 输出信号占空比**：$\mathrm{PWM 输出信号占空比}=\frac{\mathrm{TCMPBn}}{\mathrm{TCNTBn}}$    

#### 6.5 定时器的使用方法 

* 定时器的初始化方法：
	* 写 TCFG0，设置计数时钟的预分频值
	* 写 TCFG1，选择各个定时器的分频值
	* 对 TCNTBn 和 TCMPBn 分别写入计数初值和比较初值
	* 写 TCON，设置自动重装初值、手动装载初值、反相输出
	* 重写 TCON，清除手动装载初值位，设置正相输出、启动计数
* 定时器停止运行的方法：
	* 写 TCON，禁止计数初值自动重装

#### 6.6  看门狗电路的作用 
* 大致功能：
	* 作为常规定时器使用，并且可以产生中断；
	* 作为看门狗定时器使用，定时时间到，他可以产生 128 个时钟周期的复位信号。
* 详细说明： 
	* 看门狗定时器控制寄存器 WTCON：通过该寄存器，可以使能/禁止看门狗、选择输入时钟源、使能/关闭中断、使能/关闭输出。
	* 看门狗定时器数据寄存器 WTDAT：该数据寄存器用于设置看门狗定时器的初值。在初始操作中，该值不会自动加载到定时器中，首次定时器初始值时 0x8000，以后该寄存器的值会被自动加载到 WTCNT 寄存器中。一般作为普通定时器使用。 

#### 6.7 实验三 PWM 实验

>编写程序，实现用定时器 T0 的输出 PWM，改变定时器 T0 的计数器寄存器实现不同波形。本实验平台的 PCLK 的频率为 50MHz，要求 PWM 波的输出频率和占空比分别为 (100Hz, 1/2)、（100Hz，1/3）、（200Hz，1/2）、（200Hz，1/3）等。
> ![[Pasted image 20230314111050.png|400]]

```C
#include "2440addr.h"    
#include "2440lib.h"
#include "2440slib.h"  
#define UINT32T unsigned int  

void main(int argc,char **argv)
{  
     // TOUT1使能，不必要？
     // 抄上算了
     rGPBCON=rGPBCON & 0XFFFFF0|(1<<3);  
     //预分频39
     rTCFG0=39;
     //分频1/16，00000000 0000 0000 0000 0000 0011 0000
     // TCFG1中MUX1段为0011，代表采用timer1且16分频
     rTCFG1=0x03; // 0011
     rTCNTB0=780; //输出频率100Hz
     rTCMPB0=390; //占空比1/2
     // TCON的值为1111，TL0->自动重装 TO0->反相输出
     // TUP0->清除手动装载初值 TR0->启动timer0
     rTCON|=(1<<3)|(1<<2)|(1<<1)|(1<<0);
     // TCON的值为1001，TL0 - > 自动重装 TO0 - > 正向输出
     // TUP0 - > 手动装载初值 TR0 - > 启动timer0     
     rTCON&=~((1<<2)|(1<<1));                
     while(1);  
}
```

* **确定 TCNTB0 和 TCMPB0 的过程**
	* 根据预分频和分频求出 $f_{\mathrm{Tclk}}=\frac{50 \times 10^6}{39+1} \times \frac{1}{16}=78125 \mathrm{Hz}$ 
	* 根据题目中要求的输出频率 100Hz 反推 TCNTB0：$\mathrm{TCNTB0=\frac{f_{Tclk}}{100}=\frac{78125}{100}\approx780}$ 
	* 根据题目中要求的占空比要求求出 TCMPB0 ：$\mathrm{TCMPB0={TCNTB0}\times{d}=780\times 0.5}=390$ 
